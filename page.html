<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<script src="//mat1.gtimg.com/libs/jquery/1.11.1/jquery.min.js"></script>
	<link href="https://cdn-img.9118bao.com/templates/frontend/dark-corai/css/bootstrap.css" rel="stylesheet">
	<link rel="stylesheet" href="res/style.css">
	<link href="https://cdn-img.9118bao.com/templates/frontend/dark-corai/css/font-awesome.min.css" rel="stylesheet">
	<link href="https://cdn-img.9118bao.com/templates/frontend/dark-corai/css/colors.css" rel="stylesheet">
	<style>
		/* fade image in after load */
		.lazyload,
		.lazyloading {
			opacity: 0;
		}

		.lazyloaded {
			opacity: 1;
			transition: opacity 2000ms;
		}
	</style>

	<script>
		var cdn_url = "https://cdn-img.9118bao.com";
		var base_url = 'http://www.111avs.net'
		var tmb_url = "https://img.cache010.com";

		function relativeURL(urlstr) {
			var url = new URL(urlstr)
			if (url.search === '') {
				return url.pathname
			}
			return url.pathname + url.search
		}

		var parser = new DOMParser()

		var categories = []
		function getCategories() {
			fetch('/categories')
				.then(response => response.text())
				.then(body => {
					var htmlDom = parser.parseFromString(body, 'text/html')
					htmlDom.querySelectorAll('.col-sm-6.col-md-4.col-lg-4.m-b-20').forEach(item => {
						var url = item.querySelector('a').href
						var imgurl = item.querySelector('.img-responsive').src
						var val1 = item.querySelector('.title-truncate').innerText.trim()
						var val2 = parseInt(item.querySelector('.badge').innerText.trim())
						categories.push([url, imgurl, val1, val2])
					})
					console.log('end')
				})
		}


		var nextPageURL = 'http://www.111avs.net/videos/amateur'
		var videos = []
		function getVideos(callback) {
			fetch(nextPageURL)
				.then(response => response.text())
				.then(body => {
					var page = { lists: [], page: 0, nextPageURL: null, description: null }
					nextPageURL = null
					var htmlDom = parser.parseFromString(body, 'text/html')
					page.description = htmlDom.querySelector('.col-md-9.col-sm-8 > .well.well-sm').innerText.trim()

					var pdiv = htmlDom.querySelector('.pagination')
					if (pdiv) {
						page.page = parseInt(pdiv.querySelector('.active').innerText.trim())
						page.nextPageURL = nextPageURL = pdiv.querySelector('.prevnext')?.href ?? null
					}

					htmlDom.querySelectorAll('.col-sm-6.col-md-4.col-lg-4').forEach(item => {
						var hd = item.querySelector('.hd-text-icon').innerText.trim()
						if (hd === "AD") {
							return
						}

						var url = item.querySelector('a').href
						var url2 = relativeURL(url)
						url = base_url + url2
						var id = url2.split('/')[2]
						var img = item.querySelector('.img-responsive').dataset.original
						var imgurl2 = relativeURL(img)
						var duration = item.querySelector('.duration').innerText.trim()
						var title = item.querySelector('.video-title').innerText.trim()
						var added = item.querySelector('.video-added').innerText.trim()
						var views = item.querySelector('.video-views').innerText.trim()
						var rating = item.querySelector('.video-rating').innerText.trim()
						var obj = { id, url, img, hd, duration, title, added, views, rating }
						page.lists.push(obj)
						videos.push(obj)
					})
					console.log(`av: ${videos.length} pv: ${page.lists.length}`)

					if (callback) {
						callback(page)
					}

					if (nextPageURL) {
						console.log(`nextPage: ${nextPageURL}`)
						// setTimeout(getVideos, 5000)
					} else {
						console.log('end')
					}
				})
		}


		var videoUrl = '/video/4748/'
		var video = { title: null, des: null, img: null, player: null, tags: [] }
		function getVideo() {
			fetch(videoUrl)
				.then(response => response.text())
				.then(body => {
					var htmlDom = parser.parseFromString(body, 'text/html')
					video.title = htmlDom.querySelector('.visible-xs.big-title-truncate.m-t-0').innerText.trim()
					video.des = htmlDom.querySelector('.m-t-10.overflow-hidden').innerText.trim()
					video.img = htmlDom.querySelector('video').poster

					var p = document.createElement('p')
					p.innerHTML = document.querySelector('#video_embed_code').innerText
					video.player = p.querySelector('iframe').src

					htmlDom.querySelectorAll('.m-t-10.overflow-hidden > a').forEach(item => {
						video.tags.push(item.innerText.trim())
					})
					console.log('end')
				})
		}


		function renderHtml(lists) {
			var html = ''
			lists.forEach(item => {
				var tmp = `
<div class="col-sm-4 col-md-3 col-lg-3">
<div class="well well-sm">
<a href="${item.url}" target="_blank">
<div class="thumb-overlay">
<img data-src="${item.img}" src="res/loading...png" title="${item.title}" alt="${item.title}" class="lazyload img-responsive" />
<div class="hd-text-icon">${item.hd}</div>
<div class="duration">
${item.duration}
</div>
</div>
<span class="video-title title-truncate m-t-5">${item.title}</span>
</a>
<div class="video-added">
${item.added}
</div>
<div class="video-views pull-left">
${item.views}
</div>
<div class="video-rating pull-right ">
<i class="fa fa-heart video-rating-heart"></i> <b>${item.rating}</b>
</div>
<div class="clearfix"></div>
</div>
</div>`
				html += tmp
			})
			return html
		}
	</script>
</head>

<body>
	<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header"> <button type="button" class="navbar-toggle" data-toggle="collapse"
					data-target=".navbar-inverse-collapse"> <span class="sr-only">Toggle navigation</span> <span
						class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button>
				<a class="navbar-brand" href="/"><img src="/images/logo/logo.png"></a>
			</div>
			<div class="navbar-collapse collapse navbar-inverse-collapse">
				<ul class="nav navbar-nav navbar-right">
					<li><a href="/videos">课程</a></li>
					<li class="dropdown visible-sm hidden-xs hidden-md hidden-lg"> <a href="#" class="dropdown-toggle"
							data-toggle="dropdown">更多 <b class="caret"></b></a>
						<ul class="dropdown-menu">
							<li><a href="/categories">类别</a></li>
							<li><a href="/community">社区</a></li>
						</ul>
					</li>
					<li class="hidden-sm"><a href="/categories">类别</a></li>
					<li class="hidden-sm"><a href="/community">社区</a></li>
					<li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i
								class="fa fa-search"></i></a>
						<ul class="dropdown-menu search-dropdown-menu">
							<form class="form-inline" name="search" id="search_form" method="get"
								action="/search/videos">
								<div class="input-group"> <input type="text" class="form-control" placeholder="搜索"
										name="search_query" id="search_query" value="">
									<span class="input-group-btn"> <button type="submit" class="btn btn-primary"><i
												class="fa fa-search"></i></button> </span>
								</div>
							</form>
						</ul>
					</li>
				</ul>
			</div>
		</div>
	</div>
	<div id="wrapper">
		<div class="container">
			<div class="well well-filters">
				<div class="pull-left">
					<h4>最新上传课程</h4>
				</div>
				<div class="pull-right"> <a class="btn btn-primary" href="/videos?o=mr"><span class="hidden-xs"><i
								class="fa fa-plus"></i> 查看更多最新上传课程...</span><span class="visible-xs"><i
								class="fa fa-plus"></i></span></a> </div>
				<div class="clearfix"></div>
			</div>
			<div class="row">
				<div class="col-sm-12">
					<div class="row">
					</div>
					<center>
						<div class="center_related" style="display: none;  margin: -6px 0 -26px 0;"><img
								src="res/loading-bubbles.svg"></div>
						<ul class="pager">
							<li><a href="#" id="load_videos">显示更多</a></li>
						</ul>
					</center>
				</div>
			</div>
		</div>
		<div class="footer-container">
			<div class="footer">
				<div class="container">
					<div class="hidden-xs">
						<div class="pull-left"> <span>版权所有 &#169; 2019</span> 千百撸
						</div>
						<div class="pull-right"> </div>
						<div class="clearfix"></div>
					</div>
					<div class="visible-xs"><span>版权所有 &#169; 2019</span> 千百撸<br /></div>
				</div>
			</div>
		</div>
	</div>
	<script src="https://cdn-img.9118bao.com/templates/frontend/dark-corai/js/bootstrap.min.js"></script>
	<script src="http://afarkas.github.io/lazysizes/lazysizes.min.js"></script>
	<script>
		function setFooterSize() {
			document.querySelector('#wrapper').style.paddingBottom = document.querySelector('.footer-container').clientHeight + 'px'
		}

		window.addEventListener('resize', () => {
			setFooterSize()
		})
		setFooterSize()

		document.querySelector('#load_videos').addEventListener('click', e => {
			e.preventDefault()
			document.querySelector('.center_related').style.display = ''
			getVideos(page => {
				var str = renderHtml(page.lists)
				var p = document.createElement('p')
				document.querySelector('.col-sm-12 > .row').appendChild(p)
				p.outerHTML = str
				document.querySelector('.center_related').style.display = 'none'
				if (!nextPageURL) {
					document.querySelector('.pager').style.display = 'none'
				}
			})
		})

		var timer
		$('body').on('mouseover', '.img-responsive', function (event) {
			if (timer) {
				return
			}

			var data_src = this.dataset.src
			var path = data_src.substring(0, data_src.lastIndexOf('/'))
			var image_urls = []
			for (let i = 1; i < 21; i++) {
				var image_url = `${path}/${i}.jpg`
				image_urls.push(image_url)
				new Image().src = image_url
			}

			var idx = 0
			var othis = this
			timer = setInterval(() => {
				if (idx > 19) {
					clearInterval(timer)
					timer = 0
					return
				}
				othis.src = image_urls[idx]
				idx++
			}, 500)
		}).on('mouseout', '.img-responsive', function (event) {
			clearInterval(timer)
			timer = 0
			this.src = this.dataset.src
		})
	</script>
</body>

</html>